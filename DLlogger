(function () {
  window.startDataLayerLogger = function (settings) {
    // ðŸ§© KrÃ¦v settings
    if (!settings) {
      console.error('âŒ startDataLayerLogger: "settings" mangler');
      return;
    }

    // Endpoint til din Cloudflare Worker
    const endpoint = settings.endpoint || 'https://logging.larsfriis.io';
    const website_id = settings.website_id || null;
    const secret = settings.secret || null;
    const ignore_events = settings.ignore_events || [];
    const buffer = [];

    if (!website_id || !secret) {
      console.error('âŒ startDataLayerLogger: "website_id" eller "secret" mangler');
      return;
    }

    function shouldSkip(msg) {
      if (msg?.event && msg.event.startsWith('gtm')) return true;
      if (msg && msg[0] === 'set') return true;
      if (msg?.event && ignore_events.includes(msg.event)) return true;
      return false;
    }

    function queueEvent(dlEvent) {
      if (shouldSkip(dlEvent)) return;

      buffer.push({
        page_location: window.location.href,
        user_agent: navigator.userAgent,
        device_type: /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
          ? 'mobile'
          : 'desktop',
        event: dlEvent?.event || 'message',
        datalayer: dlEvent,
      });
    }

    function flush() {
      if (!buffer.length) return;

      const payload = {
        website_id,
        secret,
        events: buffer.splice(0, buffer.length),
      };

      navigator.sendBeacon(endpoint, JSON.stringify(payload));
    }

    // Fang eksisterende events
    if (Array.isArray(window.dataLayer)) {
      window.dataLayer.forEach((obj) => {
        if (obj && typeof obj === 'object') queueEvent(obj);
      });

      // Hook fremtidige pushes
      const originalPush = window.dataLayer.push;
      window.dataLayer.push = function () {
        const args = Array.from(arguments);
        const msg = args[0];
        if (msg && typeof msg === 'object') queueEvent(msg);
        return originalPush.apply(window.dataLayer, args);
      };
    } else {
      console.error('âŒ dataLayer mangler');
    }

    // Flush ved sideskift eller tab-lukning
    addEventListener('pagehide', flush);
    addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') flush();
    });

    console.log('âœ… dataLayer beacon listener startet med website_id:', website_id);
  };
})();
